"""{{ name }} - Context-Aware Assistant Web App (L2) with Lakebase memory"""
import os, sys, asyncio, uuid, yaml
from pathlib import Path
from flask import Flask, request, jsonify, render_template_string, Response

try:
    from databricks_agent_toolkit.integrations import DatabricksLLM
    import mlflow
except ImportError:
    print("‚ùå Install: pip install databricks-agent-toolkit")
    sys.exit(1)

from memory_manager import MemoryManager

# Load config
config = yaml.safe_load((Path(__file__).parent / "config.yaml").read_text())

# Initialize
app = Flask(__name__)
PORT = int(os.getenv('DATABRICKS_APP_PORT', 8000))

llm = DatabricksLLM(endpoint=config["model"]["endpoint"], auto_trace=config.get("mlflow", {}).get("auto_trace", True))
memory = MemoryManager(
    host=config["memory"].get("host"),
    database=config["memory"].get("database"),
    user=config["memory"].get("user"),
    password=config["memory"].get("password"),
    max_history=config["memory"].get("max_history", 20)
)
memory.initialize()

if config.get("mlflow", {}).get("auto_trace"):
    mlflow.set_experiment(config["mlflow"].get("experiment", "/Shared/{{ name }}"))
    print(f"üìä MLflow: {config['mlflow']['experiment']}")

print(f"üöÄ Starting {{ name }} on port {PORT}")
print(f"ü§ñ Model: {config['model']['endpoint']}")
print(f"üíæ Memory: Lakebase")

# Chat UI
CHAT_HTML = '''<!DOCTYPE html>
<html>
<head>
    <title>{{ name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { width: 90%; max-width: 800px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; height: 80vh; }
        .header { padding: 20px; border-bottom: 1px solid #eee; }
        .header h1 { font-size: 24px; color: #333; }
        .header p { font-size: 14px; color: #666; margin-top: 5px; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; }
        .bubble { padding: 12px 16px; margin: 10px 0; border-radius: 18px; max-width: 70%; word-wrap: break-word; }
        .user { background: #667eea; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .assistant { background: #f1f3f5; color: #333; border-bottom-left-radius: 4px; }
        #input-container { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #eee; }
        #input-box { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        button:hover { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .controls { padding: 10px 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .btn-small { padding: 8px 16px; font-size: 12px; background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ name }}</h1>
            <p>Context-aware assistant with memory</p>
        </div>
        <div id="chat-box"></div>
        <div class="controls">
            <button class="btn-small" onclick="clearHistory()">Clear History</button>
            <span id="session-id" style="font-size: 11px; color: #999; margin-left: auto; align-self: center;"></span>
        </div>
        <div id="input-container">
            <input type="text" id="input-box" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <script>
        let SESSION_ID = localStorage.getItem('session_id') || '';

        function addBubble(role, text) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + role;
            bubble.textContent = text;
            document.getElementById('chat-box').appendChild(bubble);
            document.getElementById('chat-box').scrollTop = 999999;
            return bubble;
        }

        function sendMessage() {
            const input = document.getElementById('input-box');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();
            if (!message) return;

            addBubble('user', message);
            input.value = '';
            sendBtn.disabled = true;

            fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message, session_id: SESSION_ID})
            })
            .then(r => r.json())
            .then(data => {
                if (data.session_id && !SESSION_ID) {
                    SESSION_ID = data.session_id;
                    localStorage.setItem('session_id', SESSION_ID);
                    document.getElementById('session-id').textContent = 'Session: ' + SESSION_ID.slice(0,8);
                }
                addBubble('assistant', data.response);
                sendBtn.disabled = false;
            })
            .catch(e => {
                addBubble('assistant', 'Error: ' + e.message);
                sendBtn.disabled = false;
            });
        }

        function clearHistory() {
            if (!confirm('Clear conversation history?')) return;
            fetch('/api/session/clear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({session_id: SESSION_ID})
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('chat-box').innerHTML = '';
                alert('History cleared');
            });
        }

        // Initialize session
        fetch('/api/session/init', {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                if (!SESSION_ID) {
                    SESSION_ID = data.session_id;
                    localStorage.setItem('session_id', SESSION_ID);
                }
                document.getElementById('session-id').textContent = 'Session: ' + SESSION_ID.slice(0,8);
            });
    </script>
</body>
</html>'''

@app.route('/')
def home():
    return render_template_string(CHAT_HTML)

@app.route('/api/session/init', methods=['POST'])
def init_session():
    return jsonify({"session_id": str(uuid.uuid4())})

@app.route('/api/chat', methods=['POST'])
@mlflow.trace(name="assistant_chat", span_type="CHAIN")
async def chat():
    data = request.json
    user_message = data.get('message', '')
    session_id = data.get('session_id') or str(uuid.uuid4())

    if not user_message:
        return jsonify({"error": "No message"}), 400

    try:
        # Store user message
        memory.store_message(session_id, "user", user_message)

        # Get history
        history = memory.get_messages_for_llm(session_id)

        # Build messages
        messages = [
            {"role": "system", "content": config["model"].get("system_prompt", "You are a helpful assistant.")},
            *history
        ]

        # Get response
        result = await llm.chat(
            messages=messages,
            temperature=config["model"].get("temperature", 0.7),
            max_tokens=config["model"].get("max_tokens", 500)
        )
        response = result["content"]

        # Store response
        memory.store_message(session_id, "assistant", response)

        return jsonify({"response": response, "session_id": session_id})
    except Exception as e:
        print(f"‚ùå Error: {e}", flush=True)
        return jsonify({"error": str(e)}), 500

@app.route('/api/session/clear', methods=['POST'])
def clear_session():
    data = request.json
    session_id = data.get('session_id')
    if session_id:
        memory.clear_conversation(session_id)
    return jsonify({"status": "cleared"})

@app.route('/health')
def health():
    return jsonify({"status": "healthy", "model": config["model"]["endpoint"], "port": PORT})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT, debug=False)
