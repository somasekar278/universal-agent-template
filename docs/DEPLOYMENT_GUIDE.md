# Databricks Apps Deployment Guide

This guide covers deploying agents generated by the Databricks Agent Toolkit to Databricks Apps.

## üìã Prerequisites

1. **Databricks Workspace** with Apps enabled
2. **Databricks CLI** installed and configured
3. **Generated agent scaffold** (via `databricks-agent-toolkit generate`)
4. **Databricks access token** with appropriate permissions

## üöÄ Quick Deployment

### Step 1: Generate Your Agent

```bash
# Generate L1-L5 scaffold
databricks-agent-toolkit generate l3 my-agent

cd my-agent
```

### Step 2: Configure Authentication

**Option A: Environment Variables** (Recommended for production)
```bash
export DATABRICKS_HOST="https://your-workspace.cloud.databricks.com"
export DATABRICKS_TOKEN="dapi123..."
```

**Option B: Databricks CLI** (Recommended for development)
```bash
databricks auth login --host https://your-workspace.cloud.databricks.com
```

### Step 3: Test Locally (Optional but Recommended)

```bash
# Install dependencies
pip install -r requirements.txt

# Run locally
python main.py  # or chatbot.py for L1, assistant.py for L2, workflow.py for L4/L5
```

### Step 4: Deploy to Databricks Apps

```bash
# Deploy with the generated databricks-app.yml
databricks apps create my-agent --file databricks-app.yml

# Check deployment status
databricks apps list

# Get app details
databricks apps get my-agent
```

### Step 5: Access Your Agent

Once deployed, your agent will be accessible at:
```
https://your-workspace.cloud.databricks.com/apps/my-agent
```

## üìù Customizing Deployment

### Resource Allocation

Edit `databricks-app.yml`:

```yaml
resources:
  cpu: "2"        # CPU cores (0.5, 1, 2, 4, 8)
  memory: "8Gi"   # Memory (2Gi, 4Gi, 8Gi, 16Gi, 32Gi)
```

**Recommendations:**
- **L1 (Simple Chatbot):** 1 CPU / 4Gi RAM
- **L2 (Context-Aware):** 1-2 CPU / 4-8Gi RAM
- **L3 (Production API):** 2-4 CPU / 8-16Gi RAM
- **L4 (Complex Workflow):** 2-4 CPU / 8-16Gi RAM
- **L5 (Multi-Agent):** 4-8 CPU / 16-32Gi RAM

### Environment Variables

```yaml
env:
  - name: MODEL_ENDPOINT
    value: "databricks-claude-sonnet-4-5"
  - name: DATABRICKS_HOST
    value: "${DATABRICKS_HOST}"
  - name: DATABRICKS_TOKEN
    value: "${DATABRICKS_TOKEN}"
  - name: LOG_LEVEL
    value: "INFO"
  - name: MAX_RETRIES
    value: "3"
```

### Auto-Scaling

```yaml
scaling:
  min_instances: 1
  max_instances: 10
  target_cpu_utilization: 70
```

### Health Checks (L3+)

```yaml
health_check:
  path: "/health"
  interval: 30
  timeout: 5
```

## üîÑ Update Existing Deployment

```bash
# Update the app with new configuration
databricks apps update my-agent --file databricks-app.yml

# Or redeploy completely
databricks apps delete my-agent
databricks apps create my-agent --file databricks-app.yml
```

## üìä Monitoring

### View Logs

```bash
# Stream logs in real-time
databricks apps logs my-agent --follow

# View recent logs
databricks apps logs my-agent --tail 100
```

### MLflow Traces

All agents automatically log to MLflow:

1. Go to: `https://your-workspace.cloud.databricks.com/ml/experiments`
2. Find experiment: `/agents/my-agent`
3. View traces, spans, and performance metrics

### Databricks Apps UI

Monitor via the UI:
```
https://your-workspace.cloud.databricks.com/apps
```

View:
- ‚úÖ Deployment status
- ‚úÖ Resource usage
- ‚úÖ Request metrics
- ‚úÖ Error rates
- ‚úÖ Logs

## üõ†Ô∏è Troubleshooting

### Common Issues

#### 1. **Authentication Failed**

**Error:** `Authentication failed: No valid credentials`

**Fix:**
```bash
# Re-authenticate
databricks auth login

# Or set environment variables
export DATABRICKS_HOST="https://..."
export DATABRICKS_TOKEN="dapi..."
```

#### 2. **Model Endpoint Not Found**

**Error:** `Model serving endpoint not found: {endpoint}`

**Fix:**
Check available endpoints:
```bash
databricks serving-endpoints list
```

Update `databricks-app.yml` with a valid endpoint.

#### 3. **Out of Memory (OOM)**

**Error:** `Container killed: Out of memory`

**Fix:**
Increase memory in `databricks-app.yml`:
```yaml
resources:
  memory: "8Gi"  # Increase from 4Gi
```

#### 4. **App Won't Start**

**Check logs:**
```bash
databricks apps logs my-agent --tail 200
```

**Common causes:**
- Missing dependencies in `requirements.txt`
- Import errors
- Configuration errors
- Authentication issues

#### 5. **Slow Performance**

**Solutions:**
1. Increase CPU/memory resources
2. Enable caching (L2+)
3. Optimize prompts
4. Use faster models (e.g., `dbrx-instruct` vs `claude-sonnet`)

## üéØ Production Best Practices

### 1. **Use Production-Grade Models**
```yaml
env:
  - name: MODEL_ENDPOINT
    value: "databricks-claude-sonnet-4-5"  # High-quality, production-ready
```

### 2. **Enable Auto-Optimization** (L4+)
```yaml
env:
  - name: ENABLE_AUTO_OPTIMIZATION
    value: "true"
  - name: OPTIMIZATION_DATASET
    value: "main.agents.training_data"
```

### 3. **Configure Telemetry**
```yaml
env:
  - name: ENABLE_TELEMETRY
    value: "true"
  - name: TELEMETRY_CATALOG
    value: "main"
  - name: TELEMETRY_SCHEMA
    value: "telemetry"
```

### 4. **Set Up Alerts**

Use Databricks SQL dashboards to monitor:
- Request latency (p50, p95, p99)
- Error rates
- Model costs
- Token usage

### 5. **Use Blue-Green Deployment**

```bash
# Deploy new version
databricks apps create my-agent-v2 --file databricks-app.yml

# Test v2
curl https://your-workspace.cloud.databricks.com/apps/my-agent-v2/chat

# Switch traffic (update routing)
databricks apps update my-agent --target my-agent-v2

# Delete old version
databricks apps delete my-agent-v1
```

## üîí Security

### 1. **Use Secrets for Tokens**

```yaml
env:
  - name: DATABRICKS_TOKEN
    valueFrom:
      secretKeyRef:
        name: databricks-token
        key: token
```

### 2. **Enable Network Policies**

```yaml
network:
  ingress:
    - cidr: "10.0.0.0/8"  # Allow only internal traffic
```

### 3. **Use Unity Catalog Permissions**

Ensure your agent's service principal has minimal permissions:
```sql
GRANT SELECT ON TABLE main.docs.knowledge TO agent_principal;
GRANT EXECUTE ON FUNCTION main.utils.embed TO agent_principal;
```

## üìö Additional Resources

- [Databricks Apps Documentation](https://docs.databricks.com/apps/)
- [Databricks Model Serving](https://docs.databricks.com/machine-learning/model-serving/)
- [MLflow Tracing](https://mlflow.org/docs/latest/llms/tracing/)
- [Databricks Agent Toolkit README](../README.md)

---

**Generated by Databricks Agent Toolkit v0.1.0**
