"""
{{ name }} - FastAPI Server with MLflow AgentServer
Generated by: Databricks Agent Toolkit v0.2.0
"""
import os
import yaml
from pathlib import Path
from fastapi import FastAPI
from fastapi.responses import HTMLResponse
from fastapi.middleware.cors import CORSMiddleware
from mlflow.genai.agent_server.server import AgentServer
import agent  # Import to register @invoke/@stream decorators

# Load config
config = yaml.safe_load((Path(__file__).parent / "config.yaml").read_text())
PORT = int(os.getenv('DATABRICKS_APP_PORT', 8000))
STREAMING = config["model"].get("streaming", False)

# Create AgentServer (automatically discovers @invoke/@stream decorated functions)
agent_server = AgentServer("ResponsesAgent")
app = agent_server.app

# Add CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Health endpoint
@app.get("/health")
def health():
    return {
        "status": "healthy",
        "model": config["model"]["endpoint"],
        "port": PORT,
        "streaming": STREAMING
    }

# UI Endpoint
CHAT_HTML = '''<!DOCTYPE html>
<html>
<head>
    <title>{{ name }}</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #FF3621; margin-bottom: 5px; }
        .subtitle { color: #666; margin-bottom: 20px; }
        #chat-container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        #chat-box { height: 500px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { padding: 10px 14px; border-radius: 18px; max-width: 70%; line-height: 1.5; word-wrap: break-word; }
        .user { align-self: flex-end; background: #007AFF; color: white; }
        .assistant { align-self: flex-start; background: #f1f1f1; color: #333; }
        #input-container { display: flex; gap: 10px; padding: 20px; background: #f9f9f9; border-top: 1px solid #e0e0e0; }
        #input-box { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        #send-btn { padding: 12px 24px; background: #007AFF; color: white; border: none; border-radius: 20px; cursor: pointer; }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>ðŸ¤– {{ name }}</h1>
    <p class="subtitle">Powered by <strong>{% raw %}{{ model }}{% endraw %}</strong></p>
    <div id="chat-container">
        <div id="chat-box"></div>
        <div id="input-container">
            <input type="text" id="input-box" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <script>
        const STREAMING = {% raw %}{{ streaming|lower }}{% endraw %};

        function addBubble(role, content) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + role;
            bubble.textContent = content;
            document.getElementById('chat-box').appendChild(bubble);
            document.getElementById('chat-box').scrollTop = 999999;
            return bubble;
        }

        async function sendMessage() {
            const input = document.getElementById('input-box');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();
            if (!message) return;

            addBubble('user', message);
            input.value = '';
            sendBtn.disabled = true;

            // OpenAI API format
            const payload = {
                input: [{role: "user", content: message}],
                stream: STREAMING
            };

            if (STREAMING) {
                const bubble = addBubble('assistant', '');

                try {
                    const response = await fetch('/api/invocations', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const {done, value} = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') break;

                                try {
                                    const json = JSON.parse(data);
                                    const content = json.choices[0]?.delta?.content;
                                    if (content) {
                                        // Display immediately - server controls the delay
                                        bubble.textContent += content;
                                        document.getElementById('chat-box').scrollTop = 999999;
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                    sendBtn.disabled = false;
                } catch (err) {
                    bubble.textContent = 'Error: ' + err.message;
                    sendBtn.disabled = false;
                }
            } else {
                try {
                    const response = await fetch('/api/invocations', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    const content = data.choices[0]?.message?.content || 'No response';
                    addBubble('assistant', content);
                    sendBtn.disabled = false;
                } catch (err) {
                    addBubble('assistant', 'Error: ' + err.message);
                    sendBtn.disabled = false;
                }
            }
        }
    </script>
</body>
</html>'''

@app.get("/", response_class=HTMLResponse)
async def ui():
    """Serve chat UI"""
    return CHAT_HTML.replace('{% raw %}{{ model }}{% endraw %}', config["model"]["endpoint"]) \
                    .replace('{% raw %}{{ streaming|lower }}{% endraw %}', str(STREAMING).lower())

# Server entry point
if __name__ == "__main__":
    import uvicorn
    print(f"ðŸš€ Starting {{ name }} on port {PORT}")
    print(f"ðŸ¤– Model: {config['model']['endpoint']}")
    print(f"ðŸ”„ Streaming: {'enabled' if STREAMING else 'disabled'}")
    uvicorn.run(app, host="0.0.0.0", port=PORT)
