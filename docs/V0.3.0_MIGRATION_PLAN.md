# v0.3.0 Migration Plan: Agent Backend + Official UI Templates

## Executive Summary

**Current Problem:**
- L1 (chatbot) and L2 (assistant) are artificially separate - only difference is memory
- We're maintaining custom HTML UIs instead of using official Databricks templates
- Users can't easily swap UIs or upgrade to production-grade frontends

**Solution:**
- Merge L1+L2 into unified **L1: Single Agent Backend** with configurable features
- Integrate with official `databricks/app-templates` for UI
- Refocus toolkit on Databricks-native agent patterns (memory, RAG, tools, orchestration)

---

## New Level Structure

### L1: Single Agent Backend
**Description:** One agent with configurable features
**Features (all optional):**
- ✅ Memory (Lakebase/pgvector)
- ✅ RAG (Vector Search/pgvector/hybrid)
- ✅ Tools (UC Functions, Python tools, MCP)
- ✅ Streaming
- ✅ MLflow tracing

**Command:**
```bash
# Minimal agent (no memory, no RAG)
dat generate agent my-bot

# With memory
dat generate agent my-bot --with-memory

# With RAG
dat generate agent my-bot --with-rag

# Full-featured
dat generate agent my-bot --with-memory --with-rag --with-tools
```

**Generated Files:**
```
my-bot/
├── agent.py              # @invoke/@stream handlers
├── config.yaml           # Model, memory, RAG settings
├── memory_manager.py     # (if --with-memory)
├── rag_manager.py        # (if --with-rag)
├── tools.py              # (if --with-tools)
├── databricks.yml        # DABs config
├── app.yaml              # App config
└── README.md
```

**Note:** No UI generated - user chooses separately (see UI Integration below)

---

### L2: Multi-Agent Orchestration
**Description:** Coordinator agent + multiple specialized agents
**Patterns:**
- Supervisor pattern (coordinator delegates to specialists)
- Sequential workflow (agent chain)
- Parallel execution (concurrent agents)

**Command:**
```bash
dat generate multi-agent my-system \
  --agents customer-support,fraud-detection,data-analysis
```

**Generated Files:**
```
my-system/
├── coordinator.py        # Main orchestration logic
├── agents/
│   ├── customer_support.py
│   ├── fraud_detection.py
│   └── data_analysis.py
├── config.yaml           # Multi-agent config
├── databricks.yml
└── README.md
```

---

### L3: Agent-to-Agent (A2A) Communication
**Description:** Cross-system agent communication via standard protocols
**Protocols:**
- OpenAI API (REST)
- MCP (Model Context Protocol)
- WebSockets (real-time)

**Command:**
```bash
dat generate a2a my-gateway \
  --expose-mcp \
  --consume external-agent-url
```

**Use Cases:**
- Enterprise: Different teams/systems/clouds
- Partner integration: External AI systems
- Microservices: Distributed agent mesh

---

### L4: Enterprise Patterns
**Description:** Production deployment patterns
**Features:**
- Governance (audit logs, approval workflows)
- Monitoring (dashboards, alerts)
- Security (rate limiting, auth, secrets)
- Cost management (token budgets, usage tracking)

**Command:**
```bash
dat generate enterprise my-prod-agent \
  --with-governance \
  --with-monitoring \
  --with-cost-controls
```

---

## UI Integration Strategy

### Step 1: Generate Agent Backend
```bash
# Create L1 agent
dat generate agent my-chatbot --with-memory
```

**Output:**
```
my-chatbot/
├── agent.py              # Backend logic only
├── start_server.py       # Minimal FastAPI (no HTML UI)
├── config.yaml
├── memory_manager.py
├── databricks.yml
└── README.md
```

### Step 2: Choose UI Template
```bash
# Option A: React (production-grade, TypeScript)
dat ui add react

# Option B: Streamlit (rapid prototyping)
dat ui add streamlit

# Option C: Gradio (ML-focused)
dat ui add gradio

# Option D: Next.js (full-stack)
dat ui add nextjs

# Option E: Dash (analytics-heavy)
dat ui add dash

# Option F: Shiny (R users)
dat ui add shiny
```

**What This Does:**
1. Clones selected template from `databricks/app-templates`
2. Configures it to point to agent backend `/api/invocations`
3. Updates `databricks.yml` with UI resources
4. Installs UI dependencies

**Result:**
```
my-chatbot/
├── agent.py              # Your agent backend
├── start_server.py       # FastAPI server
├── config.yaml
├── memory_manager.py
├── ui/                   # Official Databricks template
│   ├── src/
│   ├── package.json
│   └── ...
├── databricks.yml        # Updated with UI app
└── README.md
```

### Step 3: Deploy
```bash
databricks bundle deploy
```

**Deployed Apps:**
- `my-chatbot-backend` (Python agent on port 8000)
- `my-chatbot-ui` (React/Streamlit/etc on port 8501)

---

## Key Implementation Changes

### 1. Merge L1 + L2 Templates
**Before:**
- `templates/chatbot/` (no memory)
- `templates/assistant/` (with memory)

**After:**
- `templates/agent/` (memory is optional flag)

### 2. Remove Embedded HTML UI
**Current `start_server.py`:**
```python
CHAT_HTML = '''<!DOCTYPE html>...''' # 150+ lines of HTML
```

**New `start_server.py`:**
```python
# No HTML - just API endpoints
# UI handled by separate official template
```

### 3. Add UI Template Manager
**New file:** `databricks_agent_toolkit/ui/manager.py`
```python
class UITemplateManager:
    """Manages official Databricks UI templates"""

    def add_ui(self, agent_dir, ui_type):
        """Clone and configure official UI template"""

    def list_available(self):
        """List all available UI templates"""

    def update_ui(self, agent_dir):
        """Pull latest UI template updates"""
```

### 4. Update CLI
```python
# New commands
dat generate agent <name> [--with-memory] [--with-rag] [--with-tools]
dat ui add <react|streamlit|gradio|nextjs|dash|shiny>
dat ui list
dat ui update

# Deprecated (still work with warnings)
dat generate chatbot <name>    # → Use: dat generate agent
dat generate assistant <name>  # → Use: dat generate agent --with-memory
```

---

## Migration Guide (v0.2.x → v0.3.0)

### For Existing Users

**If you have a v0.2.x scaffold:**

1. **Continue using it** - No breaking changes to deployed apps
2. **Upgrade when ready:**
   ```bash
   # Backup current scaffold
   cp -r my-chatbot my-chatbot-v0.2-backup

   # Regenerate with v0.3.0
   dat generate agent my-chatbot --with-memory

   # Choose UI
   dat ui add react

   # Migrate config.yaml settings
   # (copy your custom settings from backup)

   # Deploy
   databricks bundle deploy
   ```

### For New Users

**Just use the new commands:**
```bash
# Create agent
dat generate agent my-bot --with-memory

# Add UI
dat ui add react

# Deploy
databricks bundle deploy
```

---

## Upstream Sync Strategy

### Monitor Official Templates
**Already implemented:** `.github/workflows/monitor-app-templates.yml`
- Daily check for updates to `databricks/app-templates`
- Create issues when new templates or changes detected

### Auto-Update UI Templates
**New command:**
```bash
dat ui update
```
**What it does:**
1. Checks for upstream changes
2. Shows diff
3. Prompts user to apply updates
4. Preserves local customizations

---

## Benefits

### 1. **Simpler Mental Model**
- ❌ Before: "Do I need chatbot or assistant?"
- ✅ After: "I need an agent. Do I want memory? RAG? Tools?"

### 2. **Production-Grade UIs**
- Maintained by Databricks
- Battle-tested
- Regular updates
- Multiple framework options

### 3. **Separation of Concerns**
- Backend: Agent logic, memory, RAG, tools (our focus)
- Frontend: UI/UX (Databricks maintains)

### 4. **Flexibility**
- Swap UIs without touching agent code
- Use same agent backend with multiple UIs
- Add custom UI if needed

### 5. **Smaller Toolkit**
- No more HTML maintenance
- Fewer templates to maintain
- Faster release cycles

---

## Timeline

### Phase 1: v0.3.0-alpha (Week 1-2)
- [ ] Merge L1+L2 templates → `templates/agent/`
- [ ] Implement `UITemplateManager`
- [ ] Add `dat ui` commands
- [ ] Update docs

### Phase 2: v0.3.0-beta (Week 3-4)
- [ ] Test with all 6 official UI templates
- [ ] Migration guide
- [ ] Example projects
- [ ] Community feedback

### Phase 3: v0.3.0 GA (Week 5-6)
- [ ] Deprecation warnings for old commands
- [ ] Full documentation rewrite
- [ ] Video tutorials
- [ ] Blog post

### Phase 4: v0.4.0 (Future)
- [ ] L2: Multi-agent scaffolds
- [ ] L3: A2A communication
- [ ] L4: Enterprise patterns

---

## Open Questions

1. **UI Template Storage:**
   - Option A: Clone from GitHub each time (slower, always fresh)
   - Option B: Cache in `~/.databricks-agent-toolkit/ui-templates/` (faster, need update mechanism)
   - **Recommendation:** Option B with `dat ui update` command

2. **Monorepo vs. Separate Apps:**
   - Option A: Backend + UI in same directory (easier local dev)
   - Option B: Separate directories (cleaner separation)
   - **Recommendation:** Option A (same directory, separate DABs apps)

3. **Custom UI Support:**
   - Should we still allow custom HTML for simple use cases?
   - **Recommendation:** Yes, but as a flag: `dat ui add custom` generates minimal HTML

4. **Backward Compatibility:**
   - How long to support old `chatbot`/`assistant` commands?
   - **Recommendation:** Keep with deprecation warnings until v1.0.0

---

## Success Metrics

- ✅ Reduced template maintenance (1 agent template instead of 2+)
- ✅ Faster UI updates (pull from upstream vs. manual)
- ✅ User satisfaction (production UIs vs. basic HTML)
- ✅ Adoption of official templates (track `dat ui add` usage)
- ✅ Reduced support burden (fewer UI customization questions)

---

## Next Steps

1. ✅ Review and approve this plan
2. Create GitHub issue for v0.3.0 tracking
3. Start Phase 1 implementation
4. Announce plan to community (if applicable)

---

**Last Updated:** 2026-01-06
**Status:** DRAFT - Awaiting Approval
