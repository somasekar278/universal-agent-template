"""
{{ name }} - Context-Aware Assistant Web App (L2)

Flask web app with conversation memory powered by Lakebase.

For Databricks Apps deployment.
"""

import os
import sys
import asyncio
import uuid
from typing import Dict, Any
import yaml
from flask import Flask, request, jsonify, render_template_string

try:
    from databricks_agent_toolkit.integrations import DatabricksLLM
    import mlflow
    INTEGRATIONS_AVAILABLE = True
except ImportError:
    INTEGRATIONS_AVAILABLE = False
    print("âŒ databricks-agent-toolkit not installed")
    sys.exit(1)

from memory_manager import MemoryManager


# ============================================================================
# Configuration
# ============================================================================

def load_config() -> Dict[str, Any]:
    """Load configuration from config.yaml"""
    with open("config.yaml", "r") as f:
        return yaml.safe_load(f)


# ============================================================================
# Flask App
# ============================================================================

app = Flask(__name__)

# Load config
config = load_config()

# Initialize LLM
llm = DatabricksLLM(
    endpoint=config["model"]["endpoint"],
    auto_trace=config.get("mlflow", {}).get("auto_trace", True)
)

# Initialize memory
memory = MemoryManager(
    host=config["memory"].get("host"),
    database=config["memory"].get("database"),
    user=config["memory"].get("user"),
    password=config["memory"].get("password"),
    max_history=config["memory"].get("max_history", 20)
)
memory.initialize()

# Set MLflow experiment
if config.get("mlflow", {}).get("auto_trace"):
    mlflow.set_experiment(config["mlflow"].get("experiment", "/Shared/{{ name }}"))


# ============================================================================
# HTML Template
# ============================================================================

HTML_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>{{ name }} - Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
            border-radius: 16px 16px 0 0;
        }
        .header h1 { font-size: 24px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .session-info {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f7f8fc;
        }
        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user { justify-content: flex-end; }
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }
        #user-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        #user-input:focus { border-color: #667eea; }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .controls {
            padding: 12px 24px;
            background: #f7f8fc;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .controls button {
            padding: 8px 16px;
            font-size: 12px;
            background: #6c757d;
        }
        .typing {
            padding: 12px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            max-width: 70%;
        }
        .typing span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing span:nth-child(1) { animation-delay: -0.32s; }
        .typing span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ name }}</h1>
            <p>Context-Aware Assistant with Memory</p>
            <div class="session-info" id="session-info">
                Session: <span id="session-id">Loading...</span>
            </div>
        </div>
        
        <div class="chat-container" id="chat-container"></div>
        
        <div class="controls">
            <button onclick="clearHistory()">ğŸ—‘ï¸ Clear History</button>
            <button onclick="showSessionInfo()">â„¹ï¸ Session Info</button>
        </div>
        
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message..." 
                   onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" id="send-btn">Send</button>
        </div>
    </div>

    <script>
        let sessionId = null;
        
        // Initialize session
        async function initSession() {
            const response = await fetch('/api/session/init', { method: 'POST' });
            const data = await response.json();
            sessionId = data.session_id;
            document.getElementById('session-id').textContent = sessionId.substring(0, 8) + '...';
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message to UI
            addMessage('user', message);
            input.value = '';
            
            // Show typing indicator
            const typing = addTypingIndicator();
            
            // Disable input
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, message: message })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                typing.remove();
                
                // Add assistant response
                addMessage('assistant', data.response);
            } catch (error) {
                typing.remove();
                addMessage('assistant', 'âŒ Error: ' + error.message);
            } finally {
                // Re-enable input
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.focus();
            }
        }
        
        // Add message to UI
        function addMessage(role, content) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Add typing indicator
        function addTypingIndicator() {
            const container = document.getElementById('chat-container');
            const typing = document.createElement('div');
            typing.className = 'message assistant';
            typing.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
            return typing;
        }
        
        // Clear conversation history
        async function clearHistory() {
            if (!confirm('Clear conversation history?')) return;
            
            const response = await fetch('/api/session/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            });
            
            if (response.ok) {
                document.getElementById('chat-container').innerHTML = '';
                addMessage('assistant', 'Conversation history cleared. Starting fresh! ğŸ¯');
            }
        }
        
        // Show session info
        async function showSessionInfo() {
            const response = await fetch(`/api/session/info?session_id=${sessionId}`);
            const data = await response.json();
            alert(`Session Info:\n\nMessages: ${data.message_count}\nFirst: ${data.first_message || 'N/A'}\nLast: ${data.last_message || 'N/A'}`);
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize on load
        window.onload = () => {
            initSession();
            document.getElementById('user-input').focus();
        };
    </script>
</body>
</html>
"""


# ============================================================================
# Routes
# ============================================================================

@app.route("/")
def index():
    """Render chat UI"""
    return render_template_string(HTML_TEMPLATE)


@app.route("/api/session/init", methods=["POST"])
def init_session():
    """Initialize a new session"""
    session_id = str(uuid.uuid4())
    return jsonify({"session_id": session_id})


@app.route("/api/chat", methods=["POST"])
async def chat():
    """Handle chat messages"""
    data = request.json
    session_id = data.get("session_id")
    message = data.get("message")
    
    if not session_id or not message:
        return jsonify({"error": "Missing session_id or message"}), 400
    
    try:
        # Store user message
        memory.store_message(session_id, "user", message)
        
        # Get conversation history
        history = memory.get_messages_for_llm(session_id)
        
        # Prepare messages
        messages = []
        if "system_prompt" in config["model"]:
            messages.append({
                "role": "system",
                "content": config["model"]["system_prompt"]
            })
        messages.extend(history)
        
        # Get LLM response
        response = await llm.chat(messages)
        assistant_response = response["content"]
        
        # Store assistant response
        memory.store_message(session_id, "assistant", assistant_response)
        
        return jsonify({"response": assistant_response})
    
    except Exception as e:
        return jsonify({"error": str(e)}), 500


@app.route("/api/session/clear", methods=["POST"])
def clear_session():
    """Clear session history"""
    data = request.json
    session_id = data.get("session_id")
    
    if not session_id:
        return jsonify({"error": "Missing session_id"}), 400
    
    memory.clear_conversation(session_id)
    return jsonify({"status": "cleared"})


@app.route("/api/session/info", methods=["GET"])
def session_info():
    """Get session statistics"""
    session_id = request.args.get("session_id")
    
    if not session_id:
        return jsonify({"error": "Missing session_id"}), 400
    
    info = memory.get_session_summary(session_id)
    return jsonify(info)


@app.route("/health")
def health():
    """Health check endpoint"""
    return jsonify({"status": "healthy"})


# ============================================================================
# Run App
# ============================================================================

if __name__ == "__main__":
    port = int(os.getenv("DATABRICKS_APP_PORT", 8000))
    print(f"""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                           â•‘
    â•‘   {{ name }} - Context-Aware Assistant (L2)              â•‘
    â•‘                                                           â•‘
    â•‘   ğŸš€ Running on http://localhost:{port}                  â•‘
    â•‘   ğŸ’¾ Memory: Lakebase (PostgreSQL)                        â•‘
    â•‘   ğŸ¤– Model: {config['model']['endpoint']}                â•‘
    â•‘                                                           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    app.run(host="0.0.0.0", port=port, debug=False)
