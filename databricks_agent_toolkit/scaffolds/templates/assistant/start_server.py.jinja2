"""
{{ name }} - FastAPI Server with MLflow AgentServer (L2 Assistant)
Generated by: Databricks Agent Toolkit v0.2.2
"""
import os
import yaml
import uuid
from pathlib import Path
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.middleware.cors import CORSMiddleware
from mlflow.genai.agent_server.server import AgentServer
import agent  # Import to register @invoke/@stream decorators
from memory_manager import MemoryManager

# Load config
config = yaml.safe_load((Path(__file__).parent / "config.yaml").read_text())
PORT = int(os.getenv('DATABRICKS_APP_PORT', 8000))
STREAMING = config["model"].get("streaming", False)

# Create AgentServer (automatically creates /invocations endpoint)
agent_server = AgentServer(agent)
app = agent_server.app

# Add CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Session management endpoints
@app.post("/api/session/init")
async def init_session():
    """Initialize a new session"""
    return {"session_id": str(uuid.uuid4())}

@app.post("/api/session/clear")
async def clear_session(request: Request):
    """Clear session history"""
    data = await request.json()
    session_id = data.get("session_id")
    if session_id:
        agent.memory.clear_session(session_id)
    return {"status": "cleared"}

# Health endpoint
@app.get("/health")
def health():
    return {
        "status": "healthy",
        "model": config["model"]["endpoint"],
        "port": PORT,
        "memory": "lakebase"
    }

# UI Endpoint
CHAT_HTML = '''<!DOCTYPE html>
<html>
<head>
    <title>{{ name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { width: 90%; max-width: 800px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; height: 80vh; }
        .header { padding: 20px; border-bottom: 1px solid #eee; }
        .header h1 { font-size: 24px; color: #333; }
        .header p { font-size: 14px; color: #666; margin-top: 5px; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 12px 16px; margin: 5px 0; border-radius: 18px; max-width: 70%; word-wrap: break-word; }
        .user { background: #667eea; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .assistant { background: #f1f3f5; color: #333; border-bottom-left-radius: 4px; }
        #input-container { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #eee; }
        #input-box { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        button:hover { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .controls { padding: 10px 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .btn-small { padding: 8px 16px; font-size: 12px; background: #6c757d; }
        .session-info { font-size: 11px; color: #999; margin-left: auto; align-self: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ name }}</h1>
            <p>Context-aware assistant with memory â€¢ {% raw %}{{ model }}{% endraw %}</p>
        </div>
        <div id="chat-box"></div>
        <div class="controls">
            <button class="btn-small" onclick="clearHistory()">Clear History</button>
            <span id="session-id" class="session-info"></span>
        </div>
        <div id="input-container">
            <input type="text" id="input-box" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <script>
        let SESSION_ID = localStorage.getItem('session_id') || '';

        function addBubble(role, content) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + role;
            bubble.textContent = content;
            document.getElementById('chat-box').appendChild(bubble);
            document.getElementById('chat-box').scrollTop = 999999;
            return bubble;
        }

        async function sendMessage() {
            const input = document.getElementById('input-box');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();
            if (!message) return;

            addBubble('user', message);
            input.value = '';
            sendBtn.disabled = true;

            // OpenAI API format with session_id
            const payload = {
                input: [{role: "user", content: message}],
                stream: false,
                session_id: SESSION_ID || undefined
            };

            try {
                const response = await fetch('/invocations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                // Update session ID if new
                if (data.session_id && !SESSION_ID) {
                    SESSION_ID = data.session_id;
                    localStorage.setItem('session_id', SESSION_ID);
                    document.getElementById('session-id').textContent = 'Session: ' + SESSION_ID.slice(0,8);
                }

                // ResponsesAgent format: data.output[0].content
                const content = data.output?.[0]?.content || data.content || 'No response';
                addBubble('assistant', content);
                sendBtn.disabled = false;
            } catch (err) {
                addBubble('assistant', 'Error: ' + err.message);
                sendBtn.disabled = false;
            }
        }

        async function clearHistory() {
            if (!confirm('Clear conversation history?')) return;
            try {
                await fetch('/api/session/clear', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: SESSION_ID})
                });
                document.getElementById('chat-box').innerHTML = '';
                alert('History cleared');
            } catch (err) {
                alert('Error clearing history: ' + err.message);
            }
        }

        // Initialize session
        (async function() {
            try {
                if (!SESSION_ID) {
                    const response = await fetch('/api/session/init', {method: 'POST'});
                    const data = await response.json();
                    SESSION_ID = data.session_id;
                    localStorage.setItem('session_id', SESSION_ID);
                }
                document.getElementById('session-id').textContent = 'Session: ' + SESSION_ID.slice(0,8);
            } catch (err) {
                console.error('Session init failed:', err);
            }
        })();
    </script>
</body>
</html>'''

@app.get("/", response_class=HTMLResponse)
async def ui():
    """Serve chat UI"""
    return CHAT_HTML.replace('{% raw %}{{ model }}{% endraw %}', config["model"]["endpoint"])

# Server entry point
if __name__ == "__main__":
    import uvicorn
    print(f"ðŸš€ Starting {{ name }} on port {PORT}")
    print(f"ðŸ¤– Model: {config['model']['endpoint']}")
    print(f"ðŸ’¾ Memory: Lakebase")
    print(f"ðŸ”„ Streaming: {'enabled' if STREAMING else 'disabled'}")
    uvicorn.run(app, host="0.0.0.0", port=PORT)
