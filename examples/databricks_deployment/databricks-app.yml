# Databricks Apps Configuration
# Production deployment for Agent Framework

name: sota-agent-production
description: Agent Framework - Production deployment with hot pools

# ============================================================================
# COMPUTE CONFIGURATION (Hot Pool - Always-On)
# ============================================================================
compute:
  type: serverless

  # Hot pool configuration
  min_instances: 2          # Always keep 2 containers warm
  max_instances: 20         # Scale up to 20 under load
  scale_to_zero: false      # NEVER scale to zero (production requirement)

  # Scaling behavior
  auto_scale: true
  scale_up:
    cpu_threshold: 70%      # Scale up when CPU > 70%
    memory_threshold: 80%   # Scale up when memory > 80%
    queue_depth: 50         # Scale up when queue > 50 requests

  scale_down:
    cooldown_minutes: 5     # Wait 5 min before scaling down
    idle_threshold: 10%     # Scale down when idle < 10%

  # Resource limits per container
  resources:
    cpu: "2"                # 2 CPU cores
    memory: "8Gi"           # 8 GB RAM
    storage: "20Gi"         # 20 GB ephemeral storage

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
env:
  # Databricks connection
  - name: DATABRICKS_HOST
    value: ${workspace.host}

  - name: DATABRICKS_TOKEN
    secret: agents/databricks-token  # Stored in Databricks secrets

  # Deployment mode
  - name: DEPLOYMENT_MODE
    value: "combined"  # or "multi-port"

  # Environment
  - name: ENVIRONMENT
    value: "production"

  # Model Serving endpoints
  - name: LLM_ENDPOINT
    value: "fraud-agent-llm"

  - name: EMBEDDING_ENDPOINT
    value: "fraud-agent-embeddings"

  # Unity Catalog paths
  - name: UC_CONFIG_PATH
    value: "/Volumes/main/agents/configs/sota_config.yaml"

  - name: UC_PROMPTS_PATH
    value: "/Volumes/main/agents/prompts"

  # Telemetry configuration
  - name: TELEMETRY_ENABLED
    value: "true"

  - name: TELEMETRY_SAMPLE_RATE
    value: "0.1"  # Sample 10% for cost efficiency

  - name: ZEROBUS_BATCH_SIZE
    value: "1000"

  - name: ZEROBUS_FLUSH_INTERVAL
    value: "10"  # seconds

# ============================================================================
# UNITY CATALOG ACCESS
# ============================================================================
unity_catalog:
  # Catalogs
  catalogs:
    - main

  # Schemas
  schemas:
    - main.agents

  # Volumes (for configs, prompts)
  volumes:
    - main.agents.configs
    - main.agents.prompts
    - main.agents.temp  # For ZeroBus temp files

  # Tables (for memory, telemetry)
  tables:
    - main.agents.memory_metadata
    - main.agents.traces
    - main.agents.metrics
    - main.agents.logs

  # Vector Search indexes
  vector_indexes:
    - main.agents.memory_index

# ============================================================================
# MODEL SERVING ACCESS
# ============================================================================
model_serving:
  endpoints:
    - fraud-agent-llm          # Main LLM (DBRX)
    - fraud-agent-embeddings   # Embeddings (MPT-7B)
    - fraud-agent-custom       # Custom fine-tuned model (if any)

# ============================================================================
# SOURCE CODE
# ============================================================================
source:
  # Option 1: From Git repository
  git:
    url: https://github.com/yourorg/fraud-detection-agent
    branch: main
    path: /

  # Option 2: From Workspace
  # workspace:
  #   path: /Workspace/apps/fraud-detection-agent

# ============================================================================
# HEALTH CHECK
# ============================================================================
health_check:
  path: /health             # Combined mode
  # path: /api/health       # If using combined mode with /api prefix
  port: 8000
  initial_delay_seconds: 30
  period_seconds: 10
  timeout_seconds: 5
  failure_threshold: 3

# ============================================================================
# NETWORKING
# ============================================================================
networking:
  # Expose main API
  ports:
    - name: http
      container_port: 8000
      protocol: TCP

  # For multi-port deployment
  # ports:
  #   - name: api
  #     container_port: 8000
  #   - name: a2a
  #     container_port: 8001
  #   - name: mcp
  #     container_port: 8002

  # Ingress (external access)
  ingress:
    enabled: true
    annotations:
      databricks.com/tls: "true"  # Enable HTTPS
    rules:
      - path: /
        backend:
          service_port: 8000

# ============================================================================
# SECURITY
# ============================================================================
security:
  # Authentication
  authentication:
    enabled: true
    type: "databricks"  # Use Databricks authentication

  # Authorization (RBAC)
  authorization:
    enabled: true
    rules:
      - path: /execute
        methods: [POST]
        required_permissions: [agents.execute]

      - path: /health
        methods: [GET]
        required_permissions: []  # Public

  # Secrets
  secrets:
    - name: databricks-token
      scope: agents
      key: databricks-token

# ============================================================================
# LOGGING
# ============================================================================
logging:
  level: INFO  # DEBUG, INFO, WARNING, ERROR
  format: json

  # Log destinations
  destinations:
    - type: delta_lake
      table: main.agents.logs

    - type: stdout  # For Databricks Apps console

# ============================================================================
# MONITORING
# ============================================================================
monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    path: /metrics
    port: 8000

  # Databricks dashboards
  dashboards:
    - name: "Agent Performance"
      query: "SELECT * FROM main.agents.metrics"
      refresh_interval: 60  # seconds

# ============================================================================
# TAGS (for cost tracking, organization)
# ============================================================================
tags:
  environment: production
  team: data-science
  project: fraud-detection
  cost-center: ml-ops
  framework: sota-agent
